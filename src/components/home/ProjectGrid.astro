---
import { getProjects } from '../../lib/sanity';
// import ProjectCard from '../cards/ProjectCard.astro'; // Agent 4

// Fetch projects
const projects = await getProjects();

// Unique tags/types for filters (simplified for now)
const filters = [
  { label: 'ALL', value: 'all' },
  { label: 'VIDEO', value: 'video' },
  { label: 'EXCAVATIONS', value: 'excavation' },
  { label: 'TOURS', value: 'tour' },
  { label: 'PUBLICATIONS', value: 'publication' }
];

// Fallback image if no images
const getImageUrl = (project: any) => {
  return project.images && project.images[0] ? project.images[0] : null; 
};
---

<section class="py-20 bg-bedrock min-h-screen" id="work">
  <div class="container mx-auto px-4 md:px-8">
    
    <!-- Section Header: The Trench -->
    <div class="flex flex-col md:flex-row md:items-end justify-between mb-12 border-b border-concrete/20 pb-4">
      <div>
        <h2 class="text-4xl md:text-5xl font-bold text-off-white text-shadow uppercase">
          Selected Work
        </h2>
      </div>
      
      <!-- Filters -->
      <div class="mt-6 md:mt-0 overflow-x-auto">
        <div class="flex space-x-1 md:space-x-4 min-w-max pb-2 md:pb-0" id="project-filters">
          {filters.map((filter) => (
            <button 
              class="filter-btn text-xs font-mono uppercase px-3 py-1 border border-transparent hover:border-concrete/50 transition-colors text-concrete data-[active=true]:text-brand-orange data-[active=true]:border-brand-orange"
              data-filter={filter.value}
              data-active={filter.value === 'all'}
            >
              {filter.label}
            </button>
          ))}
        </div>
      </div>
    </div>

    <!-- Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8" id="projects-container">
      {projects.length > 0 ? projects.map((project: any) => (
        <article class="project-item group relative aspect-[4/5] bg-neutral-900 border border-concrete/20 overflow-hidden cursor-pointer w-full" data-category={project.projectType || 'other'}>
          {/* 
            Ideally use <ProjectCard project={project} /> here.
            Inline fallback implementation below:
          */}
          <div class="absolute inset-0 w-full h-full">
            {/* Image Placeholder */}
            <div class="w-full h-full bg-neutral-800 group-hover:scale-105 transition-transform duration-700 ease-out">
                {/* Real implementation would use sanity image builder */}
                <div class="w-full h-full flex items-center justify-center text-neutral-700 font-mono text-xs">
                    {project.title}
                </div>
            </div>
            
            <!-- Overlay Gradient -->
            <div class="absolute inset-0 bg-gradient-to-t from-bedrock via-transparent to-transparent opacity-80"></div>
          
            <!-- Hover Overlay (Agent 4 spec: Orange border, Dim image) -->
            <div class="absolute inset-0 border-2 border-brand-orange opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"></div>
            <div class="absolute inset-0 bg-bedrock/40 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
          </div>

          <!-- Content -->
          <div class="absolute bottom-0 left-0 w-full p-6 z-10">
            <div class="transform translate-y-2 group-hover:translate-y-0 transition-transform duration-300">
                <span class="text-brand-orange font-mono text-xs uppercase mb-1 block">
                    {project.projectType || 'Project'}
                </span>
                <h3 class="text-xl font-bold text-off-white leading-tight mb-2 group-hover:text-brand-orange transition-colors">
                    {project.title}
                </h3>
                
                <!-- Metadata visible on hover (simulated) -->
                <div class="h-0 overflow-hidden group-hover:h-auto group-hover:mt-4 transition-all duration-300 opacity-0 group-hover:opacity-100">
                    <div class="grid grid-cols-2 gap-2 text-xs font-mono text-concrete">
                        <div>
                            <span class="block text-white/40">Location</span>
                            {project.location || 'N/A'}
                        </div>
                         <div>
                            <span class="block text-white/40">Date</span>
                            {project.date || 'N/A'}
                        </div>
                    </div>
                </div>
            </div>
          </div>
        </article>
      )) : (
        <div class="col-span-full py-20 text-center border border-dashed border-concrete/30 text-concrete font-mono">
            No projects found.
        </div>
      )}
    </div>
  </div>
</section>

<script>
  // Simple Vanilla JS for Filtering
  const buttons = document.querySelectorAll('.filter-btn');
  const items = document.querySelectorAll('.project-item');

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      // Update active state
      buttons.forEach(b => {
        b.setAttribute('data-active', 'false');
        b.classList.remove('border-brand-orange', 'text-brand-orange');
      });
      btn.setAttribute('data-active', 'true');
      btn.classList.add('border-brand-orange', 'text-brand-orange');

      const filter = btn.getAttribute('data-filter');

      items.forEach((item) => {
          const itemEl = item as HTMLElement;
          const category = itemEl.dataset.category?.toLowerCase() || '';

          if (filter === 'all' || category === filter || category.includes(filter || '')) {
             itemEl.style.display = 'block';
             // optional: add animation class
          } else {
             itemEl.style.display = 'none';
          }
      });
    });
  });
</script>
